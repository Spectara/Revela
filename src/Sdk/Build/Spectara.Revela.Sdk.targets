<!--
  Spectara.Revela.Sdk - MSBuild targets for Revela plugins and themes.

  This file is automatically imported when a project references the
  Spectara.Revela.Sdk NuGet package. It provides:

  1. Plugin build settings (EnableDynamicLoading, CopyLocalLockFileAssemblies)
  2. NuGet packaging that EXCLUDES host-provided ("shared") assemblies
  3. Inclusion of .deps.json for runtime dependency resolution

  SYNC: The shared assembly exclusion rules MUST match
        PluginLoadContext.IsSharedAssembly() in Spectara.Revela.Core.
        See: src/Core/PluginLoadContext.cs

  Shared assembly convention:
    - Spectara.Revela.*           → always shared (host provides SDK, Core, Commands)
    - System.CommandLine          → shared (CLI integration contract)
    - Spectre.Console             → shared (UI contract)
    - Microsoft.Extensions.*      → shared (framework plumbing)
      EXCEPT: *Http*, *Resilience*, *Telemetry*, *Compliance*,
              *ExceptionSummarization*, *AmbientMetadata*,
              *AutoActivation*, *ObjectPool*
-->
<Project>

  <!-- ================================================================== -->
  <!-- Plugin/Theme Build Settings                                         -->
  <!-- Ensures all dependencies are copied locally and .deps.json exists   -->
  <!-- ================================================================== -->
  <PropertyGroup Condition="'$(PackageType)' == 'RevelaPlugin' Or '$(PackageType)' == 'RevelaTheme'">
    <EnableDynamicLoading>true</EnableDynamicLoading>
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <!-- ================================================================== -->
  <!-- NuGet Package: Include plugin-specific dependencies only            -->
  <!-- Excludes shared assemblies that the Revela host already provides    -->
  <!-- ================================================================== -->
  <Target Name="_RevelaIncludePluginDependencies"
          AfterTargets="Build"
          Condition="'$(PackageType)' == 'RevelaPlugin' Or '$(PackageType)' == 'RevelaTheme'">

    <ItemGroup>
      <!-- Collect ALL dependency DLLs from build output -->
      <_RevelaAllDependencyDlls Include="$(OutputPath)*.dll"
                                Exclude="$(OutputPath)$(AssemblyName).dll" />
    </ItemGroup>

    <!-- Filter: only include DLLs that are NOT shared (i.e. not provided by host) -->
    <ItemGroup>
      <_PackageFiles Include="@(_RevelaAllDependencyDlls)"
                     Condition="!$([System.String]::new('%(Filename)').StartsWith('Spectara.Revela.'))
                                And '%(Filename)' != 'System.CommandLine'
                                And '%(Filename)' != 'Spectre.Console'
                                And (
                                  !$([System.String]::new('%(Filename)').StartsWith('Microsoft.Extensions.'))
                                  Or $([System.String]::new('%(Filename)').Contains('Http'))
                                  Or $([System.String]::new('%(Filename)').Contains('Resilience'))
                                  Or $([System.String]::new('%(Filename)').Contains('Telemetry'))
                                  Or $([System.String]::new('%(Filename)').Contains('Compliance'))
                                  Or $([System.String]::new('%(Filename)').Contains('ExceptionSummarization'))
                                  Or $([System.String]::new('%(Filename)').Contains('AmbientMetadata'))
                                  Or $([System.String]::new('%(Filename)').Contains('AutoActivation'))
                                  Or $([System.String]::new('%(Filename)').Contains('ObjectPool'))
                                )">
        <PackagePath>lib/$(TargetFramework)/</PackagePath>
        <BuildAction>None</BuildAction>
      </_PackageFiles>

      <!-- Always include .deps.json for AssemblyDependencyResolver at runtime -->
      <_PackageFiles Include="$(OutputPath)$(AssemblyName).deps.json">
        <PackagePath>lib/$(TargetFramework)/</PackagePath>
        <BuildAction>None</BuildAction>
      </_PackageFiles>
    </ItemGroup>
  </Target>

</Project>
