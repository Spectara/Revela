# Release Workflow
# Triggered by pushing a version tag (v0.0.1, v1.0.0, etc.)
# Builds native executables for all platforms and creates a GitHub Release
#
# Release contents:
# - CLI executables (per platform) with default theme included
# - Plugins as separate ZIP files (optional downloads)

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (without v prefix, e.g. 0.0.1)'
        required: true
        type: string

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # Validate version tag
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          # Use input version for manual trigger, tag for push trigger
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "ðŸ“¦ Manual trigger with version: $VERSION"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            echo "ðŸ“¦ Tag trigger with version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "   Expected: X.Y.Z or X.Y.Z-suffix (e.g. 0.0.1, 1.0.0-beta, 0.0.1-beta.1)"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Validate version is newer (tag trigger only)
        if: github.event_name == 'push'
        run: |
          CURRENT="${GITHUB_REF_NAME#v}"

          # Get all version tags, sort by version, get the latest (excluding current)
          LATEST=$(git tag -l 'v*' | grep -v "^${GITHUB_REF_NAME}$" | sed 's/^v//' | sort -V | tail -1)

          if [ -n "$LATEST" ]; then
            # Compare versions
            HIGHEST=$(echo -e "$CURRENT\n$LATEST" | sort -V | tail -1)
            if [ "$HIGHEST" != "$CURRENT" ]; then
              echo "âŒ Version $CURRENT is not greater than latest release $LATEST"
              exit 1
            fi
            echo "âœ… Version $CURRENT is greater than $LATEST"
          else
            echo "âœ… First release: $CURRENT"
          fi

  # Build native executables for each platform
  build:
    name: Build ${{ matrix.rid }}
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            artifact: revela-win-x64.zip
          - os: ubuntu-latest
            rid: linux-x64
            artifact: revela-linux-x64.tar.gz
          - os: ubuntu-latest
            rid: linux-arm64
            artifact: revela-linux-arm64.tar.gz
          - os: macos-latest
            rid: osx-x64
            artifact: revela-osx-x64.tar.gz
          - os: macos-latest
            rid: osx-arm64
            artifact: revela-osx-arm64.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Publish
        shell: bash
        run: |
          dotnet publish src/Cli/Cli.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ needs.validate.outputs.version }} \
            -o ./publish

      - name: List publish output
        run: ls -la ./publish/
        shell: bash

      - name: Build default theme
        shell: bash
        run: |
          dotnet build src/Themes/Theme.Lumina/Theme.Lumina.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Copy default theme DLL
        run: |
          # Theme DLL goes next to revela.exe so PluginLoader finds it
          cp artifacts/bin/Theme.Lumina/Release/net10.0/${{ matrix.rid }}/Spectara.Revela.Theme.Lumina.dll ./publish/
        shell: bash

      - name: Copy getting-started guides
        run: |
          mkdir -p ./publish/getting-started
          cp docs/getting-started/*.md ./publish/getting-started/
        shell: bash

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd publish
          Compress-Archive -Path revela.exe, Spectara.Revela.Theme.Lumina.dll, getting-started -DestinationPath ../${{ matrix.artifact }}
        shell: pwsh

      - name: Package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd publish
          chmod +x revela
          tar -czvf ../${{ matrix.artifact }} revela Spectara.Revela.Theme.Lumina.dll getting-started

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}
          path: ${{ matrix.artifact }}
          retention-days: 1

  # Build plugins as separate packages
  plugins:
    name: Build Plugins
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Build Plugin.Source.OneDrive
        run: |
          dotnet publish src/Plugins/Plugin.Source.OneDrive/Plugin.Source.OneDrive.csproj \
            -c Release \
            -o ./publish-plugins/onedrive \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Build Plugin.Deploy.SSH
        run: |
          dotnet publish src/Plugins/Plugin.Deploy.SSH/Plugin.Deploy.SSH.csproj \
            -c Release \
            -o ./publish-plugins/ssh \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Build Plugin.Statistics
        run: |
          dotnet publish src/Plugins/Plugin.Statistics/Plugin.Statistics.csproj \
            -c Release \
            -o ./publish-plugins/statistics \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Build Theme.Lumina.Statistics
        run: |
          dotnet publish src/Themes/Theme.Lumina.Statistics/Theme.Lumina.Statistics.csproj \
            -c Release \
            -o ./publish-plugins/lumina-statistics \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Package plugins
        run: |
          VERSION=${{ needs.validate.outputs.version }}

          # OneDrive Plugin with dependencies
          # Structure: Plugin.dll + Plugin.deps.json in root, dependencies in subfolder
          PLUGIN_NAME="Spectara.Revela.Plugin.Source.OneDrive"
          mkdir -p "./plugin-package/${PLUGIN_NAME}"

          # Copy main plugin files to root
          cp "./publish-plugins/onedrive/${PLUGIN_NAME}.dll" ./plugin-package/
          cp "./publish-plugins/onedrive/${PLUGIN_NAME}.deps.json" ./plugin-package/

          # Copy dependencies to subfolder (exclude main plugin and shared assemblies)
          for dll in ./publish-plugins/onedrive/*.dll; do
            filename=$(basename "$dll")
            # Skip the main plugin DLL and shared assemblies (loaded from host)
            if [[ "$filename" != "${PLUGIN_NAME}.dll" && \
                  "$filename" != Spectara.Revela.Core.dll && \
                  "$filename" != System.CommandLine.dll && \
                  "$filename" != Spectre.Console.dll ]]; then
              cp "$dll" "./plugin-package/${PLUGIN_NAME}/"
            fi
          done

          # Create ZIP
          cd plugin-package
          zip -r "../${PLUGIN_NAME}-v${VERSION}.zip" .
          cd ..

          # SSH Plugin (simpler - fewer dependencies)
          PLUGIN_NAME="Spectara.Revela.Plugin.Deploy.SSH"
          rm -rf ./plugin-package/*
          mkdir -p "./plugin-package/${PLUGIN_NAME}"

          cp "./publish-plugins/ssh/${PLUGIN_NAME}.dll" ./plugin-package/
          cp "./publish-plugins/ssh/${PLUGIN_NAME}.deps.json" ./plugin-package/ 2>/dev/null || true

          for dll in ./publish-plugins/ssh/*.dll; do
            filename=$(basename "$dll")
            if [[ "$filename" != "${PLUGIN_NAME}.dll" && \
                  "$filename" != Spectara.Revela.Core.dll && \
                  "$filename" != System.CommandLine.dll && \
                  "$filename" != Spectre.Console.dll ]]; then
              cp "$dll" "./plugin-package/${PLUGIN_NAME}/"
            fi
          done

          cd plugin-package
          zip -r "../${PLUGIN_NAME}-v${VERSION}.zip" .
          cd ..

          # Statistics Plugin
          PLUGIN_NAME="Spectara.Revela.Plugin.Statistics"
          rm -rf ./plugin-package/*
          mkdir -p "./plugin-package/${PLUGIN_NAME}"

          cp "./publish-plugins/statistics/${PLUGIN_NAME}.dll" ./plugin-package/
          cp "./publish-plugins/statistics/${PLUGIN_NAME}.deps.json" ./plugin-package/ 2>/dev/null || true

          for dll in ./publish-plugins/statistics/*.dll; do
            filename=$(basename "$dll")
            if [[ "$filename" != "${PLUGIN_NAME}.dll" && \
                  "$filename" != Spectara.Revela.Core.dll && \
                  "$filename" != System.CommandLine.dll && \
                  "$filename" != Spectre.Console.dll ]]; then
              cp "$dll" "./plugin-package/${PLUGIN_NAME}/"
            fi
          done

          cd plugin-package
          zip -r "../${PLUGIN_NAME}-v${VERSION}.zip" .
          cd ..

          # Lumina Statistics Theme Extension
          PLUGIN_NAME="Spectara.Revela.Theme.Lumina.Statistics"
          rm -rf ./plugin-package/*
          mkdir -p "./plugin-package/${PLUGIN_NAME}"

          cp "./publish-plugins/lumina-statistics/${PLUGIN_NAME}.dll" ./plugin-package/
          cp "./publish-plugins/lumina-statistics/${PLUGIN_NAME}.deps.json" ./plugin-package/ 2>/dev/null || true

          for dll in ./publish-plugins/lumina-statistics/*.dll; do
            filename=$(basename "$dll")
            if [[ "$filename" != "${PLUGIN_NAME}.dll" && \
                  "$filename" != Spectara.Revela.Core.dll && \
                  "$filename" != System.CommandLine.dll && \
                  "$filename" != Spectre.Console.dll ]]; then
              cp "$dll" "./plugin-package/${PLUGIN_NAME}/"
            fi
          done

          cd plugin-package
          zip -r "../${PLUGIN_NAME}-v${VERSION}.zip" .
          cd ..

      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugins
          path: |
            Spectara.Revela.Plugin.*.zip
            Spectara.Revela.Theme.*.zip
          retention-days: 1

  # Create GitHub Release with all artifacts
  release:
    name: Create Release
    needs: [validate, build, plugins]
    # Only create release on tag push, not manual trigger
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
