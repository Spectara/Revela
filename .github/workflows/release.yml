# Release Workflow
# Triggered by pushing a version tag (v0.0.1, v1.0.0, etc.)
# Builds native executables for all platforms and creates a GitHub Release
#
# Release contents:
# - CLI executables (per platform) with default theme included
# - Plugins as separate ZIP files (optional downloads)

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (without v prefix, e.g. 0.0.1)'
        required: true
        type: string

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # Validate version tag
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          # Use input version for manual trigger, tag for push trigger
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "üì¶ Manual trigger with version: $VERSION"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            echo "üì¶ Tag trigger with version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "   Expected: X.Y.Z or X.Y.Z-suffix (e.g. 0.0.1, 1.0.0-beta, 0.0.1-beta.1)"
            exit 1
          fi
          echo "‚úÖ Version format valid: $VERSION"

      - name: Validate version is newer (tag trigger only)
        if: github.event_name == 'push'
        run: |
          CURRENT="${GITHUB_REF_NAME#v}"

          # Get all version tags, sort by version, get the latest (excluding current)
          LATEST=$(git tag -l 'v*' | grep -v "^${GITHUB_REF_NAME}$" | sed 's/^v//' | sort -V | tail -1)

          if [ -n "$LATEST" ]; then
            # Compare versions
            HIGHEST=$(echo -e "$CURRENT\n$LATEST" | sort -V | tail -1)
            if [ "$HIGHEST" != "$CURRENT" ]; then
              echo "‚ùå Version $CURRENT is not greater than latest release $LATEST"
              exit 1
            fi
            echo "‚úÖ Version $CURRENT is greater than $LATEST"
          else
            echo "‚úÖ First release: $CURRENT"
          fi

  # Build native executables for each platform
  build:
    name: Build ${{ matrix.rid }}
    needs: validate
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
      attestations: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            artifact: revela-win-x64.zip
          - os: ubuntu-latest
            rid: linux-x64
            artifact: revela-linux-x64.tar.gz
          - os: ubuntu-latest
            rid: linux-arm64
            artifact: revela-linux-arm64.tar.gz
          - os: macos-latest
            rid: osx-x64
            artifact: revela-osx-x64.tar.gz
          - os: macos-latest
            rid: osx-arm64
            artifact: revela-osx-arm64.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Publish
        shell: bash
        run: |
          dotnet publish src/Cli/Cli.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:Version=${{ needs.validate.outputs.version }} \
            -o ./publish

      - name: List publish output
        run: ls -la ./publish/
        shell: bash

      - name: Build default theme
        shell: bash
        run: |
          dotnet build src/Themes/Theme.Lumina/Theme.Lumina.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:Version=${{ needs.validate.outputs.version }}

      - name: Copy default theme DLL
        run: |
          # Theme DLL goes next to revela.exe so PluginLoader finds it
          cp artifacts/bin/Theme.Lumina/Release/net10.0/${{ matrix.rid }}/Spectara.Revela.Theme.Lumina.dll ./publish/
        shell: bash

      - name: Copy getting-started guides
        run: |
          mkdir -p ./publish/getting-started
          cp docs/getting-started/*.md ./publish/getting-started/
        shell: bash

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd publish
          Compress-Archive -Path revela.exe, Spectara.Revela.Theme.Lumina.dll, getting-started -DestinationPath ../${{ matrix.artifact }}
        shell: pwsh

      - name: Package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd publish
          chmod +x revela
          tar -czvf ../${{ matrix.artifact }} revela Spectara.Revela.Theme.Lumina.dll getting-started

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}
          path: ${{ matrix.artifact }}
          retention-days: 1

  # Build plugins as NuGet packages
  plugins:
    name: Build Plugins (NuGet)
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Pack Plugin.Source.OneDrive
        run: |
          dotnet pack src/Plugins/Plugin.Source.OneDrive/Plugin.Source.OneDrive.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Plugin.Deploy.SSH
        run: |
          dotnet pack src/Plugins/Plugin.Deploy.SSH/Plugin.Deploy.SSH.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Plugin.Statistics
        run: |
          dotnet pack src/Plugins/Plugin.Statistics/Plugin.Statistics.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Theme.Lumina.Statistics
        run: |
          dotnet pack src/Themes/Theme.Lumina.Statistics/Theme.Lumina.Statistics.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: List NuGet packages
        run: ls -lh ./nupkgs/

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./nupkgs/*.nupkg

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nupkgs
          path: ./nupkgs/*.nupkg
          retention-days: 1

  # Keyless signing + checksums (cosign)
  sign:
    name: Sign Release Artifacts
    needs: [validate, build, plugins]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail

          rm -rf signatures
          mkdir -p signatures

          cd artifacts

          mapfile -t files < <(
            find . -type f \( -name '*.zip' -o -name '*.tar.gz' -o -name '*.nupkg' \) -print | sort
          )

          if [ ${#files[@]} -eq 0 ]; then
            echo "‚ùå No artifacts found to checksum/sign."
            exit 1
          fi

          : > ../signatures/SHA256SUMS
          for f in "${files[@]}"; do
            sha256sum "$f" | sed 's| \./| |' >> ../signatures/SHA256SUMS
          done

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign artifacts (keyless)
        shell: bash
        run: |
          set -euo pipefail

          cd artifacts

          mapfile -t files < <(
            find . -type f \( -name '*.zip' -o -name '*.tar.gz' -o -name '*.nupkg' \) -print | sort
          )

          for f in "${files[@]}"; do
            outBase="../signatures/${f#./}"
            mkdir -p "$(dirname "$outBase")"

            cosign sign-blob \
              --yes \
              --output-signature "${outBase}.sig" \
              --output-certificate "${outBase}.crt" \
              "$f"
          done

          cosign sign-blob \
            --yes \
            --output-signature ../signatures/SHA256SUMS.sig \
            --output-certificate ../signatures/SHA256SUMS.crt \
            ../signatures/SHA256SUMS

      - name: Upload signatures and checksums
        uses: actions/upload-artifact@v4
        with:
          name: signatures
          path: signatures/**
          retention-days: 7

  # Create GitHub Release with all artifacts
  release:
    name: Create Release
    needs: [validate, build, plugins, sign]
    # Only create release on tag push, not manual trigger
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.nupkg
            artifacts/**/SHA256SUMS*
            artifacts/**/*.sig
            artifacts/**/*.crt
