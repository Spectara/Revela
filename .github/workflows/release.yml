# Release Workflow
# Triggered by pushing a version tag (v0.0.1, v1.0.0, etc.)
# Builds native executables for all platforms and creates a GitHub Release
#
# Release contents:
# - Core: CLI executable only (downloads plugins from NuGet.org)
# - Full: CLI executable + all plugins/themes as bundled NuGet packages
# - Plugins/Themes as separate NuGet packages

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (without v prefix, e.g. 0.0.1)'
        required: true
        type: string

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # Validate version tag
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          # Use input version for manual trigger, tag for push trigger
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "üì¶ Manual trigger with version: $VERSION"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            echo "üì¶ Tag trigger with version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "   Expected: X.Y.Z or X.Y.Z-suffix (e.g. 0.0.1, 1.0.0-beta, 0.0.1-beta.1)"
            exit 1
          fi
          echo "‚úÖ Version format valid: $VERSION"

      - name: Validate version is newer (tag trigger only)
        if: github.event_name == 'push'
        run: |
          CURRENT="${GITHUB_REF_NAME#v}"

          # Get all version tags, sort by version, get the latest (excluding current)
          LATEST=$(git tag -l 'v*' | grep -v "^${GITHUB_REF_NAME}$" | sed 's/^v//' | sort -V | tail -1)

          if [ -n "$LATEST" ]; then
            # Compare versions
            HIGHEST=$(echo -e "$CURRENT\n$LATEST" | sort -V | tail -1)
            if [ "$HIGHEST" != "$CURRENT" ]; then
              echo "‚ùå Version $CURRENT is not greater than latest release $LATEST"
              exit 1
            fi
            echo "‚úÖ Version $CURRENT is greater than $LATEST"
          else
            echo "‚úÖ First release: $CURRENT"
          fi

  # Build plugins and themes as NuGet packages (platform-independent, runs first)
  packages:
    name: Build Packages (NuGet)
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Pack Theme.Lumina
        run: |
          dotnet pack src/Themes/Theme.Lumina/Theme.Lumina.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Theme.Lumina.Statistics
        run: |
          dotnet pack src/Themes/Theme.Lumina.Statistics/Theme.Lumina.Statistics.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Plugin.Statistics
        run: |
          dotnet pack src/Plugins/Plugin.Statistics/Plugin.Statistics.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Plugin.Source.OneDrive
        run: |
          dotnet pack src/Plugins/Plugin.Source.OneDrive/Plugin.Source.OneDrive.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack Plugin.Serve
        run: |
          dotnet pack src/Plugins/Plugin.Serve/Plugin.Serve.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: Pack SDK
        run: |
          dotnet pack src/Sdk/Sdk.csproj \
            -c Release \
            -o ./nupkgs \
            -p:PackageVersion=${{ needs.validate.outputs.version }} \
            -p:IncludeSymbols=false

      - name: List NuGet packages
        run: ls -lh ./nupkgs/

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./nupkgs/*.nupkg

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nupkgs
          path: ./nupkgs/*.nupkg
          retention-days: 1

  # Build native executables for each platform (Core + Full variants)
  build:
    name: Build ${{ matrix.rid }}
    needs: [validate, packages]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
      attestations: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            exe: revela.exe
          - os: ubuntu-latest
            rid: linux-x64
            exe: revela
          - os: ubuntu-latest
            rid: linux-arm64
            exe: revela
          - os: macos-latest
            rid: osx-x64
            exe: revela
          - os: macos-latest
            rid: osx-arm64
            exe: revela

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Publish CLI
        shell: bash
        run: |
          dotnet publish src/Cli/Cli.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=none \
            -p:DebugSymbols=false \
            -p:Version=${{ needs.validate.outputs.version }} \
            -o ./publish

      - name: Copy documentation
        run: |
          mkdir -p ./publish/getting-started
          cp docs/getting-started/*.md ./publish/getting-started/
        shell: bash

      - name: List publish output
        run: ls -la ./publish/
        shell: bash

      # === Core Release ===
      - name: Package Core (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd publish
          Compress-Archive -Path ${{ matrix.exe }}, getting-started -DestinationPath ../revela-${{ matrix.rid }}-core.zip
        shell: pwsh

      - name: Package Core (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd publish
          chmod +x ${{ matrix.exe }}
          tar -czvf ../revela-${{ matrix.rid }}-core.tar.gz ${{ matrix.exe }} getting-started

      # === Full Release ===
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nupkgs
          path: ./publish/packages

      - name: List packages for Full release
        run: ls -la ./publish/packages/
        shell: bash

      - name: Package Full (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd publish
          Compress-Archive -Path ${{ matrix.exe }}, packages, getting-started -DestinationPath ../revela-${{ matrix.rid }}-full.zip
        shell: pwsh

      - name: Package Full (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd publish
          tar -czvf ../revela-${{ matrix.rid }}-full.tar.gz ${{ matrix.exe }} packages getting-started

      # === Attestation & Upload ===
      - name: Attest Core build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: revela-${{ matrix.rid }}-core.*

      - name: Attest Full build provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: revela-${{ matrix.rid }}-full.*

      - name: Upload Core artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}-core
          path: revela-${{ matrix.rid }}-core.*
          retention-days: 1

      - name: Upload Full artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}-full
          path: revela-${{ matrix.rid }}-full.*
          retention-days: 1

  # Keyless signing + checksums (cosign)
  sign:
    name: Sign Release Artifacts
    needs: [validate, build, packages]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail

          rm -rf signatures
          mkdir -p signatures

          cd artifacts

          mapfile -t files < <(
            find . -type f \( -name '*.zip' -o -name '*.tar.gz' -o -name '*.nupkg' \) -print | sort
          )

          if [ ${#files[@]} -eq 0 ]; then
            echo "‚ùå No artifacts found to checksum/sign."
            exit 1
          fi

          : > ../signatures/SHA256SUMS
          for f in "${files[@]}"; do
            sha256sum "$f" | sed 's| \./| |' >> ../signatures/SHA256SUMS
          done

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign artifacts (keyless)
        shell: bash
        run: |
          set -euo pipefail

          cd artifacts

          mapfile -t files < <(
            find . -type f \( -name '*.zip' -o -name '*.tar.gz' -o -name '*.nupkg' \) -print | sort
          )

          for f in "${files[@]}"; do
            outBase="../signatures/${f#./}"
            mkdir -p "$(dirname "$outBase")"

            cosign sign-blob \
              --yes \
              --output-signature "${outBase}.sig" \
              --output-certificate "${outBase}.crt" \
              "$f"
          done

          cosign sign-blob \
            --yes \
            --output-signature ../signatures/SHA256SUMS.sig \
            --output-certificate ../signatures/SHA256SUMS.crt \
            ../signatures/SHA256SUMS

      - name: Upload signatures and checksums
        uses: actions/upload-artifact@v4
        with:
          name: signatures
          path: signatures/**
          retention-days: 7

  # Create GitHub Release with all artifacts
  release:
    name: Create Release
    needs: [validate, build, packages, sign]
    # Only create release on tag push, not manual trigger
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Generate release notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"

          cat << EOF > release-notes.md
          ## Downloads

          ### üöÄ Full Release (recommended)
          All themes and plugins included - ready to use immediately.

          | Platform | Download |
          |----------|----------|
          | Windows x64 | [revela-win-x64-full.zip](${BASE_URL}/revela-win-x64-full.zip) |
          | Linux x64 | [revela-linux-x64-full.tar.gz](${BASE_URL}/revela-linux-x64-full.tar.gz) |
          | Linux ARM64 | [revela-linux-arm64-full.tar.gz](${BASE_URL}/revela-linux-arm64-full.tar.gz) |
          | macOS Intel | [revela-osx-x64-full.tar.gz](${BASE_URL}/revela-osx-x64-full.tar.gz) |
          | macOS Apple Silicon | [revela-osx-arm64-full.tar.gz](${BASE_URL}/revela-osx-arm64-full.tar.gz) |

          ### üì¶ Core Release
          Minimal download (~15MB). Install plugins/themes via \`revela plugin install\`.

          | Platform | Download |
          |----------|----------|
          | Windows x64 | [revela-win-x64-core.zip](${BASE_URL}/revela-win-x64-core.zip) |
          | Linux x64 | [revela-linux-x64-core.tar.gz](${BASE_URL}/revela-linux-x64-core.tar.gz) |
          | Linux ARM64 | [revela-linux-arm64-core.tar.gz](${BASE_URL}/revela-linux-arm64-core.tar.gz) |
          | macOS Intel | [revela-osx-x64-core.tar.gz](${BASE_URL}/revela-osx-x64-core.tar.gz) |
          | macOS Apple Silicon | [revela-osx-arm64-core.tar.gz](${BASE_URL}/revela-osx-arm64-core.tar.gz) |

          ### üîå Individual Packages (NuGet)
          For manual installation or existing projects.

          | Package | Description |
          |---------|-------------|
          | [Spectara.Revela.Theme.Lumina.${VERSION}.nupkg](${BASE_URL}/Spectara.Revela.Theme.Lumina.${VERSION}.nupkg) | Default photography theme |
          | [Spectara.Revela.Theme.Lumina.Statistics.${VERSION}.nupkg](${BASE_URL}/Spectara.Revela.Theme.Lumina.Statistics.${VERSION}.nupkg) | Statistics extension for Lumina |
          | [Spectara.Revela.Plugin.Statistics.${VERSION}.nupkg](${BASE_URL}/Spectara.Revela.Plugin.Statistics.${VERSION}.nupkg) | Site statistics generation |
          | [Spectara.Revela.Plugin.Source.OneDrive.${VERSION}.nupkg](${BASE_URL}/Spectara.Revela.Plugin.Source.OneDrive.${VERSION}.nupkg) | OneDrive shared folder source |
          | [Spectara.Revela.Plugin.Serve.${VERSION}.nupkg](${BASE_URL}/Spectara.Revela.Plugin.Serve.${VERSION}.nupkg) | Local development server |

          ---

          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          body_path: release-notes.md
          generate_release_notes: true
          append_body: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.nupkg
            artifacts/**/SHA256SUMS
            artifacts/**/*.sig
            artifacts/**/*.crt
