name: Deploy Website

on:
  # Automatically deploy after a successful release
  workflow_run:
    workflows: ["Release"]
    types: [completed]

  # Also deploy on website content changes (uses latest existing release)
  push:
    branches: [main]
    paths:
      - 'samples/revela-website/**'

  # Manual trigger
  workflow_dispatch:

# Only one website deployment at a time
concurrency:
  group: website-deploy
  cancel-in-progress: true

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  deploy:
    name: Generate & Deploy
    runs-on: ubuntu-latest
    # Skip if triggered by a failed release workflow
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download latest Revela release
        uses: robinraju/release-downloader@v1
        with:
          repository: Spectara/Revela
          latest: true
          preRelease: true
          fileName: "revela-linux-x64-full.tar.gz"
          out-file-path: ./revela-download

      - name: Extract Revela
        run: |
          tar -xzf ./revela-download/revela-linux-x64-full.tar.gz
          chmod +x ./revela

      - name: Install theme from bundled packages
        run: |
          ./revela packages refresh
          ./revela theme install Spectara.Revela.Theme.Lumina

      - name: Generate website
        run: |
          cd samples/revela-website
          ../../revela generate all

      - name: Deploy to Revela.Website
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.WEBSITE_DEPLOY_TOKEN }}
          external_repository: Spectara/Revela.Website
          publish_branch: main
          publish_dir: ./samples/revela-website/output
          commit_message: "Deploy from ${{ github.repository }}@${{ github.sha }}"
